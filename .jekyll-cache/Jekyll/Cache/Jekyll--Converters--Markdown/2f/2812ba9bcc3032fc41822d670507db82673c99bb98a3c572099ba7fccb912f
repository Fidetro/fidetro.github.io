I"4<h1 id="å‰è¨€">å‰è¨€</h1>

<p><code class="language-plaintext highlighter-rouge">ReplayKit</code>æ˜¯WWDC15æ¨å‡ºçš„è‹¹æœåŸç”Ÿå½•å±æ¡†æ¶ï¼Œç›®çš„åœ¨äºè®©å¼€å‘è€…æ›´æ–¹ä¾¿çš„ä½¿ç”¨å±å¹•å½•åˆ¶åŠŸèƒ½ï¼Œåœ¨æ‚¦è·‘åœˆçš„é¡¹ç›®ä¸­ä¹Ÿæœ‰ç”¨åˆ°ï¼ŒAPIå¯¹å¼€å‘è€…å¯ä»¥è¯´æ˜¯éå¸¸å‹å¥½äº†ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹<code class="language-plaintext highlighter-rouge">ReplayKit</code>çš„APIã€‚</p>

<p>å¼€å§‹å½•åˆ¶</p>
<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">[[</span><span class="n">RPScreenRecorder</span> <span class="nf">sharedRecorder</span><span class="p">]</span> <span class="nf">startRecordingWithHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
       
    <span class="p">}];</span>
</code></pre></div></div>

<p>åœæ­¢å½•åˆ¶</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[[RPScreenRecorder sharedRecorder] stopRecordingWithHandler:^(RPPreviewViewController * _Nullable previewViewController, NSError * _Nullable error) {
        
}];
</code></pre></div></div>
<p>å¦å¤–åœæ­¢å½•åˆ¶çš„æ—¶å€™ï¼Œä¼šè¿”å›ä¸€ä¸ªç³»ç»Ÿçš„previewViewControllerï¼Œå¯¹æ­¤å¯ä»¥è¿›è¡Œæœ€åŸºæœ¬è§†é¢‘å‰ªè¾‘çš„ã€‚<br />
åªéœ€è¦åœ¨å›è°ƒçš„æ—¶å€™è°ƒç”¨ä¸€ä¸‹ï¼š</p>
<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">previewViewController</span><span class="p">.</span><span class="n">previewControllerDelegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
<span class="p">[</span><span class="n">self</span> <span class="nf">presentViewController</span><span class="p">:</span><span class="n">previewViewController</span> <span class="nf">animated</span><span class="p">:</span><span class="nb">YES</span> <span class="n">completion</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>

<span class="cp">#pragma mark - RPPreviewViewControllerpreviewControllerDelegate
</span><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">previewControllerDidFinish</span><span class="p">:(</span><span class="n">RPPreviewViewController</span> <span class="o">*</span><span class="p">)</span><span class="nv">previewController</span> <span class="p">{</span>
    <span class="c1">//å¤„ç†dismisså›æ¥çš„å›è°ƒ</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ•´ä½“ä¸Šæ¥çœ‹ï¼Œå¯ä»¥è¯´æ˜¯çœŸçš„å¯¹å¼€å‘è€…éå¸¸å‹å¥½äº†ï¼Œç„¶è€Œè¿™é‡Œé¢çš„å‘è¿˜æ˜¯ä¸å°‘ã€‚</p>

<h1 id="ç»†æ•°replaykitçš„å‘">ç»†æ•°ReplayKitçš„å‘</h1>

<ol>
  <li>å¼€å§‹å½•å±å’Œåœæ­¢å½•å±çš„å›è°ƒï¼Œå¹¶ä¸æ˜¯åœ¨ä¸»çº¿ç¨‹ã€‚
    <div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">[[</span><span class="n">RPScreenRecorder</span> <span class="nf">sharedRecorder</span><span class="p">]</span> <span class="nf">startRecordingWithHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
     <span class="p">[[</span><span class="n">NSOperationQueue</span> <span class="nf">mainQueue</span><span class="p">]</span><span class="nf">addOperationWithBlock</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
         <span class="c1">//è¦æ³¨æ„å›åˆ°ä¸»çº¿ç¨‹ï¼Œé¿å…çº¿ç¨‹é—®é¢˜</span>
     <span class="p">}];</span>
 <span class="p">}];</span>
</code></pre></div>    </div>
  </li>
  <li>åœæ­¢å½•å±çš„previewViewControlleræœ‰å¯èƒ½ä¸ºç©º
    <div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">[[</span><span class="n">RPScreenRecorder</span> <span class="nf">sharedRecorder</span><span class="p">]</span> <span class="nf">stopRecordingWithHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">RPPreviewViewController</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">previewViewController</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
     <span class="p">[[</span><span class="n">NSOperationQueue</span> <span class="nf">mainQueue</span><span class="p">]</span><span class="nf">addOperationWithBlock</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">previewViewController</span><span class="p">)</span> 
         <span class="p">{</span>
             <span class="n">previewViewController</span><span class="p">.</span><span class="n">previewControllerDelegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
             <span class="p">[</span><span class="n">self</span> <span class="nf">presentViewController</span><span class="p">:</span><span class="n">previewViewController</span> <span class="nf">animated</span><span class="p">:</span><span class="nb">YES</span> <span class="n">completion</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span> 
         <span class="p">}</span><span class="k">else</span>
         <span class="p">{</span>
                
         <span class="p">}</span>
     <span class="p">}];</span>
 <span class="p">}];</span>
</code></pre></div>    </div>
  </li>
  <li>previewViewControlleræ²¡æœ‰é€‚é…å…¨é¢å±
    <div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="p">(</span><span class="cm">/* å…¨é¢å± &amp;&amp; iOS 11ä»¥ä¸Š */</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">UIEdgeInsets</span> <span class="n">safeArea</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">safeAreaInsets</span><span class="p">;</span>
     <span class="n">CGFloat</span> <span class="n">safeAreaHeight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="p">(</span><span class="n">safeArea</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">safeArea</span><span class="p">.</span><span class="n">bottom</span><span class="p">);</span>
     <span class="n">CGFloat</span> <span class="n">safeAreaWidth</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="p">(</span><span class="n">safeArea</span><span class="p">.</span><span class="n">left</span> <span class="o">+</span> <span class="n">safeArea</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
     <span class="n">CGFloat</span> <span class="n">scaleX</span> <span class="o">=</span> <span class="n">safeAreaWidth</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
 <span class="n">CGFloat</span> <span class="n">scaleY</span> <span class="o">=</span> <span class="n">safeAreaHeight</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
 <span class="n">CGFloat</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">scaleX</span><span class="p">,</span> <span class="n">scaleY</span><span class="p">);</span>
 <span class="n">previewViewController</span><span class="p">.</span><span class="n">previewControllerpreviewControllerDelegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
 <span class="n">previewViewController</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformMakeScale</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">scale</span><span class="p">);</span>
 <span class="p">[</span><span class="n">self</span> <span class="nf">presentViewController</span><span class="p">:</span><span class="n">previewViewController</span> <span class="nf">animated</span><span class="p">:</span><span class="nb">YES</span> <span class="n">completion</span><span class="o">:^</span><span class="p">{</span>
     <span class="n">previewViewController</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="n">previewViewController</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">safeArea</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">previewViewController</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">safeArea</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">previewViewController</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">previewViewController</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
 <span class="p">}];</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="n">previewViewController</span><span class="p">.</span><span class="n">previewControllerpreviewControllerDelegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
 <span class="p">[</span><span class="n">self</span> <span class="nf">presentViewController</span><span class="p">:</span><span class="n">previewViewController</span> <span class="nf">animated</span><span class="p">:</span><span class="nb">YES</span> <span class="n">completion</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>åœæ­¢å½•å±åpresentåˆ°previewViewControlleræœ‰å¯èƒ½é»‘å±ï¼ˆwindowå¦‚æœæ˜¯ç™½è‰²æ˜¯ç™½å±ï¼‰<br />
è¿™ä¸ªé—®é¢˜ç›®å‰æ²¡åŠæ³•è§£å†³ï¼Œåœ¨<a href="https://stackoverflow.com/search?q=replaykit+black">stackoverflow</a>ä¸Šä¹Ÿæœ‰è®¸å¤šç›¸åŒçš„é—®é¢˜ï¼Œæš‚æ—¶æ²¡åŠæ³•è§£å†³</p>
  </li>
  <li>è°ƒç”¨åœæ­¢å½•å±æ–¹æ³•ï¼Œä¸ç®¡æˆåŠŸæˆ–å¤±è´¥æœ‰å‡ ç‡ä¸è¿›å…¥å›è°ƒ<br />
è¿™ä¸ªé—®é¢˜åŒæ ·æ— æ³•è§£å†³ï¼Œåœ¨<a href="https://forums.developer.apple.com/thread/87007">forums-develop</a>ä¸­ï¼Œä¹ŸåŒæ ·æœ‰äººæå‡ºï¼Œè¢«è‹¹æœæ ‡è®°ä¸ºå·²çŸ¥é‡å¤çš„é—®é¢˜ï¼ˆä½†æ˜¯è‡³ä»Šæ²¡ä¿®å¤â€¦</li>
</ol>

<h1 id="è§£å†³">è§£å†³</h1>
<p>é€šè¿‡ç¿»é˜…RPPreviewViewControllerçš„ç§æœ‰å±æ€§å’Œæ–¹æ³•ï¼Œå‘ç°æœ‰ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">movieURL</code>çš„å±æ€§ã€‚</p>
<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">movieURL</span> <span class="o">=</span> <span class="p">[</span><span class="n">previewViewController</span> <span class="nf">valueForKey</span><span class="p">:</span><span class="s">@"movieURL"</span><span class="p">];</span>
</code></pre></div></div>
<p>å¯ä»¥é€šè¿‡è·å–KVCçš„æ–¹å¼ï¼Œè·å–è§†é¢‘åœ°å€ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…é»‘å±çš„é—®é¢˜äº†ï¼Œåªæ˜¯è¿™æ ·ï¼Œå¦‚æœè¦åšè§†é¢‘å‰ªè¾‘ï¼Œå°±éœ€è¦å¦å¤–è‡ªå®šä¹‰é¡µé¢äº†ã€‚ä½†æ˜¯åœæ­¢å½•å±ä¸è¿›å…¥å›è°ƒå’ŒpreviewViewControlleræœ‰å¯èƒ½ä¸ºnilçš„é—®é¢˜ï¼Œä¾æ—§æ— æ³•è§£å†³ã€‚</p>
:ET
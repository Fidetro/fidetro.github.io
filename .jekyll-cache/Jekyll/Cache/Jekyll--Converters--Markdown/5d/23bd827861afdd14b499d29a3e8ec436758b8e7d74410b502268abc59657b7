I"À-<h1 id="å‰è¨€">å‰è¨€</h1>

<p>åœ¨iOS 11åï¼Œæœ‰ä¸ª<a href="https://support.apple.com/zh-cn/HT204681">æ¥åŠ›</a>çš„åŠŸèƒ½éå¸¸å¥½ç”¨ï¼Œå¯ä»¥åœ¨iPhoneå’ŒMacä¸Šå…±äº«å‰ªè´´æ¿ç­‰ã€‚ä½†æ˜¯è‡ªå·±ç”¨çš„æ—¶å€™ï¼Œæ€»æœ‰å¾ˆå¤šå°é—®é¢˜ï¼Œæ˜æ˜éœ€è¦æ‰“å¼€çš„éƒ½æ‰“å¼€äº†æ¥åŠ›å¤±æ•ˆã€ä¸Šä¸€æ¬¡å¤åˆ¶çš„æ˜¯å›¾ç‰‡åæ¥å¤åˆ¶çš„æ˜¯æ–‡æœ¬ï¼ŒiPhoneç›´æ¥å‰ªè´´æ¿éƒ½ä¸å‡ºæ¥äº†ã€‚ç»å†äº†ä¸€é¡¿éœ€æ±‚åˆ†æä¹‹åï¼Œå†³å®šè‡ªå·±åŠ¨æ‰‹åšä¸€ä¸ªã€‚<br />
æ—¢ç„¶è¦å®ç°è·¨å¹³å°ï¼Œå…ä¸äº†è¦æ¶‰åŠåˆ°æœåŠ¡å™¨ï¼Œé€‰æ‹©è‡ªå·±å»å†™è¿˜æ˜¯ä½¿ç”¨ç°æœ‰çš„äº‘æœåŠ¡ï¼Œæˆä¸ºäº†å½“å‰é€‰æ‹©çš„æœ€å¤§é—®é¢˜ã€‚
ä¸ºäº†è§£å†³åˆå¿«<del>æ‡’</del>åˆå®‰å…¨<del>æ‡’</del>çš„é—®é¢˜ï¼Œæˆ‘æœ€ç»ˆé€‰æ‹©äº†è‹¹æœè‡ªå¸¦çš„<code class="language-plaintext highlighter-rouge">CloudKit</code>ã€‚</p>

<h1 id="cloudkit">CloudKit</h1>
<p><code class="language-plaintext highlighter-rouge">CloudKit</code>æ˜¯è‹¹æœåœ¨WWDC2014æ¨å‡ºé€šè¿‡iCloudæœåŠ¡å­˜å‚¨ç»“æ„åŒ–åº”ç”¨ç¨‹åºå’Œç”¨æˆ·æ•°æ®çš„æ¡†æ¶ï¼Œé€šè¿‡<code class="language-plaintext highlighter-rouge">CloudKit</code>è·å–appç°æœ‰æ•°æ®å¹¶å°†å…¶å­˜å‚¨åœ¨äº‘ä¸­ï¼Œå®ç°ç”¨æˆ·å¤šè®¾å¤‡è®¿é—®ã€‚</p>

<h2 id="å®¹å™¨containers">å®¹å™¨ï¼ˆContainersï¼‰</h2>

<p>ä¸€ä¸ªAppå¯ä»¥åˆ›å»ºå’Œæ‹¥æœ‰å¤šä¸ªå®¹å™¨ï¼š<br />
<img src="https://developer.apple.com/library/archive/documentation/DataManagement/Conceptual/CloudKitQuickStart/Art/3_specifycontainers2_2x.png" alt="" /></p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//åˆ›å»ºå®¹å™¨</span>
<span class="k">let</span> <span class="nv">container</span> <span class="o">=</span> <span class="kt">CKContainer</span><span class="p">(</span><span class="nv">identifier</span><span class="p">:</span> <span class="s">"åœ¨Capabilitiesé€‰æ‹©çš„å®¹å™¨identifier"</span><span class="p">)</span>
</code></pre></div></div>

<p>ä¸€ä¸ªå®¹å™¨ä¸­æ‹¥æœ‰<code class="language-plaintext highlighter-rouge">Public</code>ã€<code class="language-plaintext highlighter-rouge">Private</code>ã€<code class="language-plaintext highlighter-rouge">Shared</code>ä¸‰ç§æ•°æ®åº“ï¼Œé€šè¿‡<code class="language-plaintext highlighter-rouge">CKContainer</code>çš„å®ä¾‹è·å–ï¼š</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">CKContainer</span> <span class="p">{</span>

    <span class="kd">open</span> <span class="k">var</span> <span class="nv">privateCloudDatabase</span><span class="p">:</span> <span class="kt">CKDatabase</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>

    <span class="kd">open</span> <span class="k">var</span> <span class="nv">publicCloudDatabase</span><span class="p">:</span> <span class="kt">CKDatabase</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>

    <span class="kd">@available</span><span class="p">(</span><span class="kt">OSX</span> <span class="mf">10.12</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
    <span class="kd">open</span> <span class="k">var</span> <span class="nv">sharedCloudDatabase</span><span class="p">:</span> <span class="kt">CKDatabase</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ä¸åŒç±»å‹çš„æ•°æ®åº“ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„è¡¨æ ¼å¯¹æ¯”ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ç±»å‹</th>
      <th style="text-align: center">å ç”¨ç”¨æˆ·iCloudå®¹é‡</th>
      <th style="text-align: center">éœ€è¦ç™»å½•iCloud</th>
      <th style="text-align: center">è®¿é—®</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">privateCloudDatabase</td>
      <td style="text-align: center">æ˜¯</td>
      <td style="text-align: center">æ˜¯</td>
      <td style="text-align: center">ç™»å½•iCloudåå…è®¸è®¿é—®ï¼Œæ•°æ®è·ŸéšiCloudè´¦å·</td>
    </tr>
    <tr>
      <td style="text-align: center">publicCloudDatabase</td>
      <td style="text-align: center">å¦ï¼Œä½¿ç”¨çš„æ˜¯appçš„å…¬å…±iCloudå®¹é‡ï¼Œå…·ä½“å‚è€ƒ<a href="https://developer.apple.com/icloud/cloudkit/">è¿™é‡Œ</a></td>
      <td style="text-align: center">å¦</td>
      <td style="text-align: center">å…è®¸ä¸ç™»å½•iCloudè´¦å·ï¼Œä½†åªèƒ½è¯»å–ï¼Œä¸èƒ½å†™å…¥ï¼ŒåŒbundle idä¸‹æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½è®¿é—®</td>
    </tr>
    <tr>
      <td style="text-align: center">sharedCloudDatabase</td>
      <td style="text-align: center">å¦</td>
      <td style="text-align: center">æ˜¯</td>
      <td style="text-align: center">æ‰€æœ‰appéƒ½å¯ä»¥è®¿é—®</td>
    </tr>
  </tbody>
</table>

<h1 id="ä½¿ç”¨">ä½¿ç”¨</h1>

<blockquote>
  <p>åœ¨å†™ä»£ç ä¹‹å‰ï¼Œéœ€è¦å…ˆå»<a href="https://icloud.developer.apple.com/dashboard/">CloudKit dashboard</a>ï¼Œåˆ›å»º<code class="language-plaintext highlighter-rouge">Record Type</code>ï¼ŒåŒæ—¶åœ¨æ–°å»ºçš„Record Typeé¡µé¢æ–°å¢å­—æ®µï¼Œå¢åŠ å®Œå­—æ®µä¹‹åï¼Œè®°å¾—è¦ä¸ºå­—æ®µæ·»åŠ <code class="language-plaintext highlighter-rouge">recordName</code>ç´¢å¼•ï¼Œä¸ç„¶æŸ¥è¯¢çš„æ—¶å€™ä¼šæŠ¥é”™ã€‚</p>
</blockquote>

<p><img src="https://developer.apple.com/library/archive/documentation/DataManagement/Conceptual/CloudKitQuickStart/Art/2017RecordTypes_2x.png" alt="" /></p>

<ol>
  <li>åˆ›å»ºæŒ‡å®šå”¯ä¸€è®°å½•åç§°çš„è®°å½•IDã€‚
    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">artworkRecordID</span> <span class="o">=</span> <span class="kt">CKRecordID</span><span class="err">ï¼ˆ</span><span class="n">recordName</span><span class="err">ï¼šâ€œ</span><span class="mi">115</span><span class="err">â€ï¼‰</span>
</code></pre></div>    </div>
  </li>
  <li>åˆ›å»ºä¸€ä¸ªè®°å½•å¯¹è±¡ã€‚
    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">artworkRecord</span> <span class="o">=</span> <span class="kt">CKRecord</span><span class="err">ï¼ˆ</span><span class="n">recordType</span><span class="err">ï¼šâ€œ</span><span class="kt">Artwork</span><span class="err">â€ï¼Œ</span><span class="n">recordID</span><span class="err">ï¼š</span><span class="n">artworkRecordID</span><span class="err">ï¼‰</span>
</code></pre></div>    </div>
  </li>
  <li>è®¾ç½®è®°å½•çš„å­—æ®µ
    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">artworkRecord</span><span class="p">[</span><span class="s">"title"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"MacKerricher State Park"</span>
<span class="n">artworkRecord</span><span class="p">[</span><span class="s">"artist"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Mei Chen"</span>
<span class="n">artworkRecord</span><span class="p">[</span><span class="s">"address"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Fort Bragg, CA"</span>
</code></pre></div>    </div>
  </li>
  <li>åˆå§‹åŒ–å®¹å™¨å¹¶è·å–æ•°æ®åº“å¯¹è±¡
    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">myContainer</span> <span class="o">=</span> <span class="kt">CKContainer</span><span class="p">(</span><span class="nv">identifier</span><span class="p">:</span> <span class="s">"iCloud.com.example.ajohnson.GalleryShared"</span><span class="p">)</span> <span class="c1">//å¦‚æœä½¿ç”¨é»˜è®¤å®¹å™¨ï¼ŒCKContainer.default()  </span>
<span class="k">let</span> <span class="nv">publicDatabase</span> <span class="o">=</span> <span class="n">myContainer</span><span class="o">.</span><span class="n">publicCloudDatabase</span>
</code></pre></div>    </div>
  </li>
  <li>ä¿å­˜å¯¹è±¡
    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">publicDatabase</span><span class="o">.</span><span class="nf">save</span><span class="p">(</span><span class="n">artworkRecord</span><span class="p">)</span> <span class="p">{</span>
 <span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
 <span class="k">guard</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">else</span> <span class="p">{</span>
     <span class="c1">// å¤„ç†é”™è¯¯</span>
     <span class="k">return</span>
 <span class="p">}</span>
 <span class="c1">// ...ä¿å­˜æˆåŠŸä¹‹åçš„å¤„ç†</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>æŸ¥è¯¢
    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="k">let</span> <span class="nv">predicate</span> <span class="o">=</span> <span class="kt">NSPredicate</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
     <span class="k">let</span> <span class="nv">query</span> <span class="o">=</span> <span class="kt">CKQuery</span><span class="p">(</span><span class="nv">recordType</span><span class="p">:</span> <span class="s">"Artwork"</span><span class="p">,</span> <span class="nv">predicate</span><span class="p">:</span> <span class="n">predicate</span><span class="p">)</span>
     <span class="n">myContainer</span>
     <span class="o">.</span><span class="n">publicCloudDatabase</span>
     <span class="o">.</span><span class="nf">perform</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nv">inZoneWith</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="p">{</span>
         <span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span> <span class="k">in</span>
         <span class="kt">OperationQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">addOperation</span> <span class="p">{</span>
                 <span class="k">guard</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">else</span> <span class="p">{</span>
                   <span class="c1">// å¤„ç†é”™è¯¯</span>
                 <span class="k">return</span>
                 <span class="p">}</span>
                 <span class="c1">// ...ä¿å­˜æˆåŠŸä¹‹åçš„å¤„ç†</span>
         <span class="p">}</span>
     <span class="p">})</span>
</code></pre></div>    </div>
  </li>
</ol>

<h1 id="åº”ç”¨">åº”ç”¨</h1>
<p>é€šè¿‡<code class="language-plaintext highlighter-rouge">CloudKit</code>ï¼Œæˆ‘åˆ†åˆ«åœ¨iOSä¸Šä½¿ç”¨Today Widgetï¼Œåœ¨Macä¸Šç›‘å¬é”®ç›˜ç»„åˆé”®æ¥å®ç°äº†æ¥åŠ›ä¸­çš„å…±äº«ç²˜è´´æ¿åŠŸèƒ½ï¼Œç›®å‰åŠŸèƒ½è¿˜æ¯”è¾ƒç®€å•ï¼Œä¸è¿‡åŸºæœ¬ä¹Ÿæ»¡è¶³äº†æˆ‘è‡ªå·±çš„éœ€æ±‚äº†ï¼Œåç»­æœ‰æ—¶é—´è¿˜æ˜¯ä¼šå®Œå–„ä¸€ä¸‹å¤åˆ¶å›¾ç‰‡ã€é¢„è§ˆè¿™äº›å°åŠŸèƒ½çš„ï¼Œ<a href="https://github.com/Fidetro/KTCloud">ä»£ç </a>åœ¨è¿™é‡Œï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹ä¸€ä¸‹ã€‚</p>

<h1 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h1>
<p><a href="https://developer.apple.com/library/archive/documentation/DataManagement/Conceptual/CloudKitQuickStart/Introduction/Introduction.html#//apple_ref/doc/uid/TP40014987-CH1-SW1">CloudKitå®˜æ–¹æ–‡æ¡£</a><br />
<a href="https://developer.apple.com/documentation/cloudkit/ckcontainer">CKcontainerå®˜æ–¹æ–‡æ¡£</a></p>
:ET
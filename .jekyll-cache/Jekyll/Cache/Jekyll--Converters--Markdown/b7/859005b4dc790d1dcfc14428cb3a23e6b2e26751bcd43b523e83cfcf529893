I"Å?<p>æœ€è¿‘æ€»ç®—æœ‰ç‚¹æ—¶é—´å†™åšå®¢äº†ï¼Œè¿™æ¬¡è®²çš„æ˜¯WWDC 2018ä¸­çš„<a href="https://developer.apple.com/videos/play/wwdc2018/220/">Session 220 High Performance Auto Layut</a></p>

<p><code class="language-plaintext highlighter-rouge">AutoLayout</code>ä½œä¸ºå¹³æ—¶ç”¨çš„æœ€å¤šçš„å¸ƒå±€æ–¹æ¡ˆï¼Œä½†æ˜¯åœ¨æ€§èƒ½ä¸Šæ€»æ˜¯é¥±å—ç—…å¢ï¼Œé€šè¿‡è¿™ä¸ªsessionï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°<code class="language-plaintext highlighter-rouge">AutoLayout</code>æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œä»¥åŠåœ¨iOS 12ä¸Š<code class="language-plaintext highlighter-rouge">AutoLayout</code>å¾—åˆ°äº†æ€æ ·çš„æå‡ã€‚</p>

<h1 id="æ­£æ–‡">æ­£æ–‡</h1>

<blockquote>
  <p>talk is cheap,show me the code</p>
</blockquote>

<p>å…ˆä¸Šæ¥å°±æ˜¯ä¸€æ®µä»£ç ï¼Œå‘Šè¯‰äº†æˆ‘ä»¬ï¼Œä¸è¦æ¯æ¬¡æ›´æ–°çº¦æŸçš„æ—¶å€™ï¼Œéƒ½æŠŠæ‰€æœ‰çš„çº¦æŸç§»é™¤ï¼Œè¿™æ ·æ˜¯é”™è¯¯çš„ï¼š</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Donâ€™t do this! Removes and re-adds constraints potentially at 120 frames per second</span>
<span class="k">override</span> <span class="kd">func</span> <span class="nf">updateConstraints</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">NSLayoutConstraint</span><span class="o">.</span><span class="nf">deactivate</span><span class="p">(</span><span class="n">myConstraints</span><span class="p">)</span>
    <span class="n">myConstraints</span><span class="o">.</span><span class="nf">removeAll</span><span class="p">()</span>
    <span class="k">let</span> <span class="nv">views</span> <span class="o">=</span> <span class="p">[</span><span class="s">"text1"</span><span class="p">:</span><span class="n">text1</span><span class="p">,</span> <span class="s">"text2"</span><span class="p">:</span><span class="n">text2</span><span class="p">]</span>
    <span class="n">myConstraints</span> <span class="o">+=</span> <span class="kt">NSLayoutConstraint</span><span class="o">.</span><span class="nf">constraints</span><span class="p">(</span><span class="nv">withVisualFormat</span><span class="p">:</span> <span class="s">"H:|-[text1]-[text2]"</span><span class="p">,</span>
                                                    <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">alignAllFirstBaseline</span><span class="p">],</span>
                                                    <span class="n">myConstraints</span> <span class="o">+=</span> <span class="kt">NSLayoutConstraint</span><span class="o">.</span><span class="nf">constraints</span><span class="p">(</span><span class="nv">withVisualFormat</span><span class="p">:</span> <span class="s">"V:|-[text1]-|"</span><span class="p">,</span>
                                                                                                    <span class="nv">metrics</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">views</span><span class="p">:</span> <span class="n">views</span><span class="p">)</span>
        <span class="nv">options</span><span class="p">:</span> <span class="p">[],</span>
        <span class="nv">metrics</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">views</span><span class="p">:</span> <span class="n">views</span><span class="p">)</span>
    <span class="kt">NSLayoutConstraint</span><span class="o">.</span><span class="nf">activate</span><span class="p">(</span><span class="n">myConstraints</span><span class="p">)</span>
    <span class="k">super</span><span class="o">.</span><span class="nf">updateConstraints</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>
<p>è€Œä¸”ä»è¿™æ®µæ³¨é‡Šå°±éšçº¦é€éœ²äº†ï¼Œå°½ç®¡ç›®å‰ä¸èƒ½è¾¾åˆ°120fpsï¼Œä½†æ˜¯åœ¨æœªæ¥çš„iPhoneå¾ˆæœ‰å¯èƒ½èƒ½è¾¾åˆ°120fpsï¼Œæ‰€ä»¥å¹¶ä¸å»ºè®®æˆ‘ä»¬è¿™æ ·æ“ä½œã€‚<br />
æ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯é€šè¿‡æ‡’åŠ è½½çš„æ–¹å¼ï¼Œå¦‚æœå·²ç»æ·»åŠ äº†çº¦æŸï¼Œå°±ä¸éœ€è¦å†ç§»é™¤ï¼Œå†æ·»åŠ äº†ï¼š</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// This is ok! Doesnâ€™t do anything unless self.myConstraints has been nilâ€™d out</span>
<span class="k">override</span> <span class="kd">func</span> <span class="nf">updateConstraints</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">myConstraints</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="kt">NSLayoutConstraint</span><span class="p">]()</span>
        <span class="k">let</span> <span class="nv">views</span> <span class="o">=</span> <span class="p">[</span><span class="s">"text1"</span><span class="p">:</span><span class="n">text1</span><span class="p">,</span> <span class="s">"text2"</span><span class="p">:</span><span class="n">text2</span><span class="p">]</span>
        <span class="n">constraints</span> <span class="o">+=</span> <span class="kt">NSLayoutConstraint</span><span class="o">.</span><span class="nf">constraints</span><span class="p">(</span><span class="nv">withVisualFormat</span><span class="p">:</span> <span class="s">"H:|-[text1]-[text2]"</span><span class="p">,</span>
                                                      <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">alignAllFirstBaseline</span><span class="p">],</span>
                                                      <span class="nv">metrics</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
                                                      <span class="nv">views</span><span class="p">:</span> <span class="n">views</span><span class="p">)</span>
        <span class="n">constraints</span> <span class="o">+=</span> <span class="kt">NSLayoutConstraint</span><span class="o">.</span><span class="nf">constraints</span><span class="p">(</span><span class="nv">withVisualFormat</span><span class="p">:</span> <span class="s">"V:|-[text1]-|"</span><span class="p">,</span>
                                                      <span class="nv">options</span><span class="p">:</span> <span class="p">[],</span>
                                                      <span class="nv">metrics</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
                                                      <span class="nv">views</span><span class="p">:</span> <span class="n">views</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kt">NSLayoutConstraint</span><span class="o">.</span><span class="nf">activate</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
    <span class="k">self</span><span class="o">.</span><span class="n">myConstraints</span> <span class="o">=</span> <span class="n">constraints</span>
    <span class="k">super</span><span class="o">.</span><span class="nf">updateConstraints</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸ºäº†æ›´å¥½è®©æˆ‘ä»¬ç†è§£â€œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšâ€ï¼Œè€Œä¸æ˜¯è®©æˆ‘ä»¬çŸ¥é“â€œå°±æ˜¯å¾—è¿™æ ·åšâ€ï¼Œè¿™ä¸ªsessionç»™å‡ºäº†æ›´è¯¦ç»†çš„è§£é‡Šã€‚</p>

<p>å½“æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªViewï¼Œç»™è¿™ä¸ªViewå»æ·»åŠ çº¦æŸçš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ªå’Œçº¦æŸå¯¹åº”çš„ç­‰å¼ï¼Œå°†å…¶æ·»åŠ åˆ°è®¡ç®—çº¦æŸçš„å¼•æ“ä¸­ï¼Œå¼•æ“ä¼šå°†çº¦æŸè§£é‡Šæˆè§†å›¾çš„å¸ƒå±€å˜é‡ï¼Œæœ€ç»ˆè®¾ç½®è§†å›¾çš„xï¼Œyï¼Œwidthï¼Œheightã€‚</p>

<p>ä¾‹å¦‚æˆ‘ä»¬è¦åˆ›å»ºä¸‹å›¾çš„è§†å›¾å…³ç³»ï¼š<br />
<img src="https://www.foolishtalk.org/cloud/2018_9_8_autolayout_1.png" alt="" /></p>

<p>çº¦æŸä¼šè½¬æ¢æˆä»¥ä¸‹çš„ç­‰å¼ï¼š<br />
<img src="https://www.foolishtalk.org/cloud/2018_9_8_autolayout_2.png" alt="" /></p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">text1</span><span class="o">.</span><span class="n">minX</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">text1</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">text2</span><span class="o">.</span><span class="n">minX</span> <span class="o">=</span> <span class="n">text1</span><span class="o">.</span><span class="n">minX</span> <span class="o">+</span> <span class="n">text1</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="mi">20</span>
</code></pre></div></div>
<p>æœ€ç»ˆå°†å˜é‡ä»£å…¥å…¬å¼ä¸­å¾—åˆ°æœ€ç»ˆçš„å€¼ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">text1</span><span class="o">.</span><span class="n">minX</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">text1</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">text2</span><span class="o">.</span><span class="n">minX</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">+</span> <span class="mi">20</span>
<span class="n">text2</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">128</span>
</code></pre></div></div>
<p>åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œå¼•æ“å¯¹è¿™ä¸ªå¸ƒå±€çš„è®¡ç®—å°±å·²ç»å®Œæˆäº†ã€‚<br />
æ¯å½“å¼•æ“å°†è®¡ç®—å¾—åˆ°çš„å€¼èµ‹å€¼ç»™å˜é‡çš„æ—¶å€™ï¼Œå®ƒä¼šå‘Šè¯‰è§†å›¾ï¼Œä½ çš„å˜é‡å·²ç»å‘ç”Ÿäº†æ”¹å˜ï¼Œè¿™æ—¶å€™è§†å›¾åˆ™ä¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">Superview.setNeedsLayout()</code>é€šçŸ¥çˆ¶è§†å›¾å‘ç”Ÿäº†å˜åŒ–,ç„¶åè§†å›¾ä¼šæ‰§è¡Œ<code class="language-plaintext highlighter-rouge">layoutSubviews()</code>,åŒæ—¶è¯¢é—®å¼•æ“å˜åŒ–çš„å€¼æ˜¯ä»€ä¹ˆï¼Œå¼•æ“å‘Šè¯‰è§†å›¾çš„å€¼ï¼Œå°±ä¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">setBounds()</code>å’Œ<code class="language-plaintext highlighter-rouge">setCenter()</code>ï¼Œç„¶åå®Œæˆæ•´ä¸ªå¸ƒå±€çš„è¿‡ç¨‹ã€‚</p>

<p>å¦‚æœå¸Œæœ›åœ¨ä½¿ç”¨<code class="language-plaintext highlighter-rouge">AutoLayout</code>çš„æ—¶å€™ï¼Œæé«˜æ€§èƒ½ï¼Œåœ¨é‡åˆ°ä¸€ä¸ªè§†å›¾ï¼Œä¼šå‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œä¸è¦<code class="language-plaintext highlighter-rouge">removeAll()</code>ï¼Œè¿™æ ·ä¼šé€ æˆçº¦æŸæµå¤±ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚è€Œæ˜¯åœ¨ä¸éœ€è¦ä½¿ç”¨çš„æ—¶å€™ï¼Œè°ƒç”¨<code class="language-plaintext highlighter-rouge">deactivate()</code>ä½¿çº¦æŸæš‚æ—¶å¤±æ•ˆ,è€Œå†æ¬¡éœ€è¦ç”¨åˆ°çš„æ—¶å€™è°ƒç”¨<code class="language-plaintext highlighter-rouge">activate()</code>å†æ¬¡æ¿€æ´»ã€‚<br />
æˆ‘ä»¬åœ¨ä½¿ç”¨<code class="language-plaintext highlighter-rouge">AutoLayout</code>çš„æ—¶å€™ï¼Œå¤§å¤šæ•°ä¼šä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹åº“ï¼Œè€Œä¸ä¼šç›´æ¥ä½¿ç”¨è‹¹æœåŸç”Ÿæä¾›çš„VFLæˆ–è€…å…¶ä»–åŸç”Ÿapiï¼Œåœ¨<code class="language-plaintext highlighter-rouge">Objective-C</code>ä¸­ä¼šä½¿ç”¨<code class="language-plaintext highlighter-rouge">Masonry</code>ï¼Œåœ¨<code class="language-plaintext highlighter-rouge">Swift</code>ä¸­ä¼šä½¿ç”¨<code class="language-plaintext highlighter-rouge">SnapKit</code>ï¼Œä¸‹é¢ä»¥<code class="language-plaintext highlighter-rouge">SnapKit</code>ä¸ºä¾‹å­ï¼š</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="nv">firstConstraint</span><span class="p">:</span> <span class="kt">Constraint</span><span class="p">?</span>
<span class="k">var</span> <span class="nv">secondConstraint</span><span class="p">:</span> <span class="kt">Constraint</span><span class="p">?</span>

<span class="kd">func</span> <span class="nf">setupLayout</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">view</span><span class="o">.</span><span class="n">snp</span><span class="o">.</span><span class="n">makeConstraints</span> <span class="p">{</span> <span class="n">make</span> <span class="k">in</span> 
     <span class="n">firstConstraint</span> <span class="o">=</span> <span class="n">make</span><span class="o">.</span><span class="n">bottom</span><span class="o">.</span><span class="nf">equalTo</span><span class="p">(</span><span class="n">otherView</span><span class="o">.</span><span class="n">snp</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span><span class="o">.</span><span class="n">constraint</span>
     <span class="n">secondConstraint</span> <span class="o">=</span> <span class="n">make</span><span class="o">.</span><span class="n">bottom</span><span class="o">.</span><span class="nf">equalToSuperview</span><span class="p">()</span><span class="o">.</span><span class="n">constraint</span>
  <span class="p">}</span>
  <span class="n">firstConstraint</span><span class="p">?</span><span class="o">.</span><span class="nf">activate</span><span class="p">()</span>
  <span class="n">secondConstraint</span><span class="p">?</span><span class="o">.</span><span class="nf">deactivate</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">updateLayout</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">something</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="o">...</span>
  <span class="k">if</span> <span class="n">something</span>  <span class="p">{</span>
    <span class="n">firstConstraint</span><span class="p">?</span><span class="o">.</span><span class="nf">activate</span><span class="p">()</span>
    <span class="n">secondConstraint</span><span class="p">?</span><span class="o">.</span><span class="nf">deactivate</span><span class="p">()</span>    
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">firstConstraint</span><span class="p">?</span><span class="o">.</span><span class="nf">deactivate</span><span class="p">()</span>
    <span class="n">secondConstraint</span><span class="p">?</span><span class="o">.</span><span class="nf">activate</span><span class="p">()</span>
  <span class="p">}</span>

</code></pre></div></div>

<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>å‰©ä¸‹ä¸€éƒ¨åˆ†æ˜¯æ¯”è¾ƒé›¶æ•£çš„å°æŠ€å·§ï¼Œæ‰€ä»¥æ”¾åˆ°æ€»ç»“ä¸­ï¼š</p>
<ul>
  <li>åœ¨ä½¿ç”¨ä¼˜å…ˆçº§çš„æ—¶å€™ï¼Œå¼•æ“ä¼šè¿›è¡Œæ›´å¤šçš„è®¡ç®—ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</li>
  <li>åœ¨è§†å›¾ä¸­çš„å­è¯•å›¾å­˜åœ¨ä¸åŒçŠ¶æ€çš„æ—¶å€™ï¼Œéœ€è¦æ˜¾ç¤ºæˆ–ç§»é™¤çš„æ—¶å€™ï¼Œå¯ä»¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨éšè—è§†å›¾ã€æ¿€æ´»çº¦æŸã€å¤±æ•ˆçº¦æŸå»é¿å…çº¦æŸæµå¤±ã€‚</li>
  <li>éƒ¨åˆ†æ§ä»¶æ˜¯å…·æœ‰å›ºå®šå°ºå¯¸çš„ï¼Œä¾‹å¦‚UIImageViewä¼šæ ¹æ®UIImageçš„å¤§å°å»é€‚åº”å°ºå¯¸ï¼ŒåŸç†ä¹Ÿæ˜¯é€šè¿‡UIViewåˆ›å»ºçº¦æŸï¼Œä½ å¯ä»¥è‡ªå·±å»è®¾å®šå¤§å°ï¼Œè¿™æ ·å°±ä¼šè·³è¿‡ç³»ç»Ÿè®¡ç®—çº¦æŸçš„æ­¥éª¤ï¼Œä½†æ˜¯ä¸è¦è®¤ä¸ºè¿™æ ·å¯ä»¥æé«˜æ€§èƒ½ã€‚ä½†æ˜¯æœ‰ä¸€ç§æƒ…å†µä¸‹æ˜¯å¯ä»¥æé«˜æ€§èƒ½çš„ï¼Œå°±æ˜¯åœ¨ä½¿ç”¨UILabelçš„æ—¶å€™ï¼Œå¦‚æœä½ è‡ªå·±æ‰‹åŠ¨å»è®¡ç®—labelçš„sizeçš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡é‡å†™<code class="language-plaintext highlighter-rouge">var intrinsicContentSize: CGSize</code>å±æ€§,å‘Šè¯‰ç³»ç»Ÿä¸éœ€è¦å¸®æˆ‘ä»¬è®¡ç®—ã€‚
    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">var</span> <span class="nv">intrinsicContentSize</span><span class="p">:</span> <span class="kt">CGSize</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kt">CGSize</span><span class="p">(</span><span class="nv">width</span><span class="p">:</span> <span class="kt">UIView</span><span class="o">.</span><span class="n">noIntrinsicMetric</span><span class="p">,</span> <span class="nv">height</span><span class="p">:</span> <span class="kt">UIView</span><span class="o">.</span><span class="n">noIntrinsicMetric</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>å°½å¯èƒ½å°‘è°ƒç”¨<code class="language-plaintext highlighter-rouge">systemLayoutSizeFitting(_:)</code>æ–¹æ³•ï¼Œå®ƒä¼šä¸´æ—¶åˆ›å»ºä¸€ä¸ªå¼•æ“ï¼Œç„¶åè¿”å›sizeä¹‹åä¸¢å¼ƒï¼Œé¢‘ç¹çš„è°ƒç”¨ï¼Œä¼šé€ æˆæ€§èƒ½ä¸‹é™ã€‚</li>
</ul>
:ET